<!DOCTYPE html>
<html ng-app="myApp">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audience</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

	<!-- Angular -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/angular-xeditable/0.8.0/css/xeditable.min.css" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-xeditable/0.8.0/js/xeditable.min.js"></script>

</head>
<body class="">
    <div id="wrapper">
	<!-- left wrapper -->
	<div w3-include-html="leftWrapper.html"></div>
	<!-- /end left wrapper -->
	<div id="page-wrapper" class="gray-bg">
		<div class="row border-bottom">
				 <nav class="navbar navbar-static-top  " role="navigation" style="margin-bottom: 0">
				<!-- top wrapper -->
				<div w3-include-html="topWrapper.html"></div>
				<!-- / top wrapper -->
				</nav>
		</div>	

<!-- content -->
<div ng-controller="myNewCtrl" id="myNewCtrl">
        <div class="row wrapper border-bottom white-bg page-heading">
            <div class="col-lg-10">
                <!-- <h2>Edit List: "{{item['LIST-NAME']}}" [{{item['LIST-COUNT']}} People]</h2> -->
            </div>
        </div>
        <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">                        
                        <div class="ibox-content">
						      <form id="idForm">
                        
								<div class="form-group"><label class="col-sm-2 control-label">List Name</label>
                                    <div class="col-sm-10">								
									<input type="text" class="form-control" placeholder="You want some cool stuff?" name="LISTNAME" id="LISTNAME" ng-model="item['LIST-NAME']" >
									<span class="help-block m-b-none">This is what appears in your targeting options.  Make it memorable.</span>
                                    </div>
                                </div>

								 <div class="tab-content"><div id="tab-1" class="tab-pane active"><div class="panel-body"></div></div></div>
	
                                <div class="form-group"><label class="col-sm-2 control-label">Description</label>
                                    <div class="col-sm-10">
									<input type="text" class="form-control" placeholder="Describe your list for easy future reference" name="LISTDESCRIPTION" id="LISTDESCRIPTION" ng-model="item['LIST-DESCRIPTION']">
									<span class="help-block m-b-none">Give yourself a little reminder.  You're sure not getting any younger.</span>
                                    </div>
                                </div>

								 <div class="tab-content"><div id="tab-1" class="tab-pane active"><div class="panel-body"></div></div></div>

                                <div class="form-group"><label class="col-sm-2 control-label">List Definition</label>
                                    <div class="col-sm-10">
                                        <div>
                                        <textarea class="form-control" id="LISTDEFINITION" name="LISTDEFINITION" rows="3" ng-model="item['LIST-DEFINITION']"></textarea>
                                        </div>                                    
                                    </div>
                                </div>

								 <div class="tab-content"><div id="tab-1" class="tab-pane active"><div class="panel-body"></div></div></div>

                                <div class="form-group">
                                    <div class="col-sm-2 col-sm-offset-2">
                                        <button class="btn btn-danger" name="action" value="checkCount" onclick="CountClick()">Check Count</button>
										<button class="btn btn-danger" name="setFilter" value="setFilter" onclick="FilterClick()">Create Filter</button>
                                    </div>
									<div class="row wrapper border-bottom white-bg page-heading" id="filterDiv" style="display:none;">
										<button id='addRow' onclick="AddRow();">Add</button>
										<input type="radio" name="joinrow" value="and" checked> AND
										<input type="radio" name="joinrow" value="or" > OR

										<div class="table-responsive">
											<table id="filterTable" class="table table-striped table-bordered " >
											<thead>
											<tr>
												<th>Row</th>
												<th>Field</th>
												<th>Operator</th>
												<th>Value</th>
												<th></th>
											</tr>
											</thead>
											<tbody>
											</tbody>
										</table>
										<button class="btn btn-danger" name="okFilter" value="okFilter" onclick="okFilterClick('new')">OK</button>
										<input type="hidden" id="itemCount" name="itemCount" value="" >							
									</div>

								</div>

								 <div class="tab-content"><div id="tab-1" class="tab-pane active"><div class="panel-body"></div></div></div>
								
								<div class="form-group">
                                    <div class="col-sm-3 col-sm-offset-2">                                       
                                        <input type="hidden" name="contactDetail" id="contactDetail" value="Engagement Rate: TBD">
                                        <input type="hidden" name="LISTIDHASH" id="LISTIDHASH" value="">
										<input type="hidden" name="LISTCOUNT" id="LISTCOUNT" ng-model="item['LIST-COUNT']" value="0">
										<button class="btn btn-primary" ng-click="Save()">Save</button>
                                        <button class="btn btn-white" ng-click="cancel()">Cancel</button>
                                    </div>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>        
</div><!-- myNewCtrl -->
<!--/ content -->           
			<div class="footer">
			<!-- footer -->
			<div w3-include-html="footer.html"></div>
			<!-- / footer -->			
			</div>
		</div><!--  end page-wrapper -->
</div>

    <!-- Mainly scripts -->
	<script src="js/w3data.js"></script>	
	<script>w3IncludeHTML();</script>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="js/inspinia.js"></script>
    <script src="js/plugins/pace/pace.min.js"></script>
	 
	 <!-- Page-Level Scripts -->
 	<script src="js/jquery.md5.js"></script>
	<script src="js/davinci.js"></script>
<script>
$(document).ready(function() {
		//angular.element('#myCtrl').scope.Load();
		$.ajax({
				url: 'getFieldList.php', // point to server-side PHP script 
				dataType: 'json',  // what to expect back from the PHP script, if anything
				cache: false,
				contentType: false,
				processData: false,
				data: '',                         
				type: 'get',
				success: function(json){										
					if (json.success) {
						FieldOption = json.fieldOption;						
					}
					
				}
		 });
}); <!-- doc.ready -->

var accountProfile = {
	"firstname" : "ff",
	"lastname" : "test",
	"accName" : "ftest",
	"email" : "ftest@example.com",
	"pass" : "password",
};
		
Array.prototype.getIndexByValue = function (name, value) 
{
		for (var i = 0, len=this.length; i <len; i++) {
			if (this[i][name]) {
				if (this[i][name] === value) {
					return i
				}
			}
		}
		return -1;
};

var OperatorOption = 
"<option value=\"\" ><\/option>"+
"<option value=\"After\" >After<\/option>"+
"<option value=\"AfterEqual\" >AfterEqual<\/option>"+
"<option value=\"Before\" >Before<\/option>"+
"<option value=\"BeforeEqual\" >BeforeEqual<\/option>"+
"<option value=\"Contains\" >Contains<\/option>"+
"<option value=\"EndsWith\" >EndsWith<\/option>"+
"<option value=\"Equal\" >Equal<\/option>"+
"<option value=\"NotContains\" >NotContains<\/option>"+
"<option value=\"NotEndsWith\" >NotEndsWith<\/option>"+
"<option value=\"NotEqual\" >NotEqual<\/option>"+
"<option value=\"NotStartsWith\" >NotStartsWith<\/option>"+
"<option value=\"StartsWith\" >StartsWith<\/option>";
var FieldOption = "";
var counter = 1;



var cid = getParameterByName("cid");
var indx = -1; 
var myApp = angular.module('myApp', ["xeditable"]);

//myCtrl
myApp.controller('myCtrl',function($scope,$http) {

			$scope.Reset = function() {
                  $scope.audience  = angular.copy($scope.master);
				  indx = $scope.audience.items.getIndexByValue('contactID',cid);						  
				  if(cid == 'new' || indx == -1){
					  $scope.audience.items.push({"contactID":"","LIST-NAME":"","LIST-COUNT":"0","LIST-DESCRIPTION":"","LIST-DEFINITION":"","LISTID-HASH":"","contactDetail":""});
				  }else{					 
					 $scope.item = $scope.audience.items[indx];
				  }
            };
			$scope.Load = function() {
                $http.get("/couchdb/" + accountProfile.accName +'/audienceLists').then(function(response) {
                     $scope.master  = response.data; 
                     if (typeof $scope.master.items == 'undefined') {
                       $scope.master.items = [];
                     } 
                     $scope.Reset();
                });
            };
			$scope.Save = function() {
					if(indx == -1 ){  					//generate new contactID
						var LName = $scope.item['LIST-NAME']; 
						alert("LName = "+LName); 					
						var keyword = LName+getCurrentDateTime();
						var conID = $.md5(keyword);
						alert(conID); 					
						$scope.myCopyItem('contactID',conID); 

					}
					$http.put('/couchdb/' + accountProfile.accName +'/audienceLists',  $scope.audience).then(function(response){
	                     $scope.Load();
						 alert("Save success");
					});         
			};
			$scope.cancel = function() {
					window.location.href="audiences.html"; 
			};
			
			$scope.myCopyItem = function (ItemName,data) {
				//alert(indx); 
				if(indx != -1)
					$scope.audience.items[indx][ItemName] = data; 
				else
				    $scope.item[ItemName] = data; 
			};

			$scope.Load();
}); //myCtrl
	

function CountClick() {
			var form_data = $("#idForm").serialize();			
			$.ajax({
				url: 'countClick.php', // point to server-side PHP script 
				dataType: 'json',  // what to expect back from the PHP script, if anything
				cache: false,
				contentType: false,
				processData: false,
				data: form_data,                         
				type: 'get',
				success: function(json){					
					var count = "0"; 
					if (json.success) {
						count = json.count;						
						// set LIST-COUNT
					}
					alert (count+' Contact(s) found');
				}
			 });
}

function FilterClick() {
		$('#filterDiv').show();
}

function AddRow() {
		var tabData = "<tr>"+
		"<td>"+counter+"<input type=\"hidden\" name=\"rownumber"+counter+"\" id=\"rownumber"+counter+" value='"+counter+"'\"></td>"+
		"<td><select name=\"fieldoption"+counter+"\" id=\"fieldoption"+counter+"\">"+FieldOption+"</select></td>"+
		"<td><select name=\"operatoroption"+counter+"\" id=\"operatoroption"+counter+"\">"+OperatorOption+"</select></td>"+
		"<td><input type=\"text\" name=\"filtervalue"+counter+"\" id=\"filtervalue"+counter+"\"></td>"+
		"<td><input type=\"button\" value=\"Del\" onclick=\"delRow(this,"+counter+")\"></td>"+
		"</tr>";
		$('#filterTable > tbody').append(tabData); 		
		counter++;			
}

function delRow(row, index) {
		var rowCount = $('#filterTable tr').length;			
		if (index == rowCount) {
			counter--;
		} else if (rowCount == 2) {
			counter = 1;
		}
		$(row).closest('tr').remove();			
}

function okFilterClick(page) {
		var table = document.getElementById('filterTable');
		var rowLength = table.rows.length;
		if (rowLength == 1) {
			alert("Please set filter.");
		} else {
			$('#itemCount').val(counter);
			var LISTDEFINITION = "";
			var form_data = $("#idForm").serialize();			
			
			$.ajax({
					url: 'createFilter.php', // point to server-side PHP script 
					dataType: 'json',  // what to expect back from the PHP script, if anything
					cache: false,
					contentType: false,
					processData: false,
					data: form_data,                         
					type: 'get',
					success: function(json){					
						if (json.success) {
							$('#LISTDEFINITION').val(json.Filter);
							if(page!='new')		angular.element(document.getElementById('myCtrl')).scope().myCopyItem('LIST-DEFINITION',json.Filter);
							$('#filterDiv').hide();
						}
					}
			});			
		}	
}

//myNewCtrl
myApp.controller('myNewCtrl',function($scope,$http) {
			$scope.Save = function() {
						var LName = $('#LISTNAME').val();		//alert("LName = "+LName); 					
						var keyword = LName+getCurrentDateTime();
						var conID = $.md5(keyword);      //alert(conID); 					
						$scope.LoadData(conID); 
			};

			$scope.SaveDB = function(cID) {					
						$http.put('/couchdb/' + accountProfile.accName +'/audienceLists',  $scope.audience).then(function(response){
							 alert("Save success");
							 window.location.href="editContact.html?cid="+cID; 
						});         
			};
			$scope.cancel = function() {
					window.location.href="audiences.html"; 
			};


			$scope.LoadData = function(contactID) {
                $http.get("/couchdb/" + accountProfile.accName +'/audienceLists').then(function(response) {
						 $scope.master  = response.data; 
						 if (typeof $scope.master.items == 'undefined') {
								$scope.master.items = [];
						 } 
						 $scope.audience  = angular.copy($scope.master);
						 var LName = $('#LISTNAME').val();
						 var LCnt = $('#LISTCOUNT').val();
						 var LDesc = $('#LISTDESCRIPTION').val();
						 var LDef = $('#LISTDEFINITION').val();
						 var LHash= $('#LISTIDHASH').val();
						 var LDetail = $('#contactDetail').val();						 
						 $scope.audience.items.push({"contactID":contactID,"LIST-NAME":LName,"LIST-COUNT":LCnt,"LIST-DESCRIPTION":LDesc,"LIST-DEFINITION":LDef,"LISTID-HASH":LHash,"contactDetail":LDetail});
 						$scope.SaveDB(contactID); 
                });
            };

}); //myNewCtrl
</script>
	

</body>

</html>
